clear all
close all
%% Full order observer controller MIMO.
A = zeros(8,8); A(1,5) = 1; A(2,6) = 1; A(3,7) = 1; A(4,8) = 1;
B = [zeros(8,4)];B(8,4) = 2180; B(7,3) = 1/1.28; B(6,2) = 1/1.28; B(5,1) = 1/1.28; % B = [0;1/M]
C = eye(8)
D = zeros(8,4);

Desired_poles = [-6:1/7:-5];
Desired_zeroes = [-8:1/7:-7];
Desired_poles_obs = [-18:1/7:-17];

Desired_poles = [-2:1/7:-1];
Desired_zeroes = [-3:1/7:-2];
Desired_poles_obs = [-5:1/7:-4];

F=-place(A,B,Desired_poles) % State feedback


sys=ss(A,B,C,0);

CL= feedback(sys,F,1);

CLpoles=pole(CL);

% Find N 
Aza = A+B*F+L*C;
Cza = -F;


M_tilde=-place(Aza',Cza',Desired_zeroes)'

Acl = [A B*F;-L*C Aza]
B_tilde_cl = [B;M_tilde]
Ccl = [C zeros(4,8)]
N = -(Ccl*Acl^-1*B_tilde_cl)^-1
M = M_tilde*N

Bcl = [B*N;M]
final_sys = ss(Acl,Bcl,Ccl,0);


%% Ragnar in Joint space
J = [ -0.20692744238625918480350970935772, -0.23282465150808832388798617301067, -0.0018037394338624440108555852751087, -0.0027237770654514239686242003705982, -0.046616676828534540626855364172696, -0.0043748266894397930680961665394113;
 -0.09440614997175165108304277955125,  0.10209781154318461836545535862476,   0.078089231278121947994100512042756,  -0.072098953728305185208200060909319,    0.7805471762235340934000536416031,  -0.040288946639337048302070978576621;
 -0.21627192163420201278899880299186,  0.22559725618732246493193350428491,   0.059792826385790176857266488243252,  -0.053883416061764900301277363243659,   0.23621817697563653972723486143913,   -0.18405060743418255596581026724899;
-0.041545569051812333499312072499567,  0.11163173537246140150506802982555,     0.9660893787883126728554260627726,   -0.93960574614494256095106946083486,   -11.307111158243912352730846661859,     4.4612301412348968719237050190032];

Task_op = [0; 0.5; -0.4; deg2rad(90)];
Joint_op = [1.0187; 2.0405; 0.0915; 2.9254; 0.58469; 0.62011];

